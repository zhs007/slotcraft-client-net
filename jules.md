# 项目概要：游戏网络库

## 1. 核心目标

开发一个健壮、高效且轻量级的 TypeScript 前端网络库。该库将作为游戏应用层与游戏服务器之间的通信桥梁，处理 WebSocket 连接、协议交互、状态同步和错误恢复。

## 2. 核心功能

- **连接管理**: 维护与游戏服务器的单一 WebSocket 连接。
- **状态机**: 管理从“未连接”到“游戏中”的完整生命周期状态。
- **协议封装**: 提供简洁的 API (`send`)，内部处理 `ctrlid` 等协议细节。
- **事件驱动**: 通过监听/事件模式与游戏模块解耦交互。
- **自动重连**: 在网络中断时，自动尝试重新连接、登录和进入游戏。
- **请求缓存**: 在断线期间缓存关键的游戏操作（如 `gamectrl`），并在重连成功后自动发送。
- **Keep-Alive**: 自动处理心跳消息，维持长连接。

## 3. 技术规约

- **语言**: TypeScript，提供完整的类型定义。
- **依赖**: 最小化原则，优先使用平台原生 API（如浏览器 `WebSocket`）。
- **测试**: 使用 Jest 进行单元测试，逻辑代码覆盖率目标 > 90%。
- **打包**: 兼容 Vite 环境，可通过 `npm install` 直接集成。
- **文档**: 提供中英双语的详细使用文档和 API 参考。

## 4. 关键设计原则

- **接口简洁**: 对游戏层暴露的接口应尽可能简单，隐藏底层复杂性。`connect`、`login`、`enter_game` 应合并为单个异步操作。
- **状态明确**: 库内部必须精确追踪当前状态，并能正确处理在任何状态下收到的用户请求或服务器消息。
- **错误处理**: 严格遵循服务器文档定义的错误码和处理流程。
- **无阻塞**: 与游戏层的交互均为异步非阻塞，通过事件通知结果。
- **高容错**: 网络问题不应导致游戏状态丢失或操作失败，库应尽最大努力恢复。

## 5. 目录结构

```
.
├── docs/              # 文档 (服务器协议、使用说明)
├── dist/              # 打包后的产物
├── src/               # 源代码
│   ├── types.ts       # 核心类型定义
│   ├── connection.ts  # WebSocket 封装
│   ├── main.ts        # 主模块（状态机、API）
│   └── event-emitter.ts # 事件分发器
├── tests/             # 测试文件
├── jules/             # 开发计划
├── .gitignore
├── package.json
├── tsconfig.json
└── jest.config.js
```

## 6. 示例 (Examples)

为了方便开发者理解和快速上手，项目在 `examples/` 目录下提供了一些可以直接运行的示例脚本。

- **`examples/example001.ts`**:
  - **功能**: 演示了完整的客户端生命周期：连接服务器、版本校验、登录、进入游戏、执行操作（Spin），并最终断开连接。
  - **配置**: 通过根目录的 `.env` 文件进行配置（`WEBSOCKET_URL`, `TOKEN`, `GAME_CODE`）。
  - **协议日志**: 该示例最重要的功能之一是它会将所有与服务器的上下行通信记录到 `msg001.txt` 文件中。这份日志可以作为开发和调试，乃至实现 Mock Server 的重要依据。
  - **运行**: `npx ts-node examples/example001.ts`
